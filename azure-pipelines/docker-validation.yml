# Docker Build Validation Pipeline
# Equivalent to .github/workflows/docker.yml

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - "**.py"
      - "Dockerfile"
      - ".dockerignore"
      - ".python-version"
      - "pyproject.toml"
      - "uv.lock"
      - "azure-pipelines/docker-validation.yml"

pr:
  branches:
    include:
      - main
  paths:
    include:
      - "**.py"
      - "Dockerfile"
      - ".dockerignore"
      - ".python-version"
      - "pyproject.toml"
      - "uv.lock"
      - "azure-pipelines/docker-validation.yml"

pool:
  vmImage: "ubuntu-latest"

stages:
  - stage: Lint
    displayName: "Lint Dockerfile"
    jobs:
      - job: HadolintCheck
        displayName: "Hadolint Dockerfile Linting"
        steps:
          - checkout: self

          - script: |
              docker run --rm -i hadolint/hadolint < Dockerfile
            displayName: "Run Hadolint"

  - stage: Build
    displayName: "Build Docker Image"
    dependsOn: Lint
    condition: succeeded()
    jobs:
      - job: DockerBuild
        displayName: "Build Docker Image"
        steps:
          - checkout: self

          - task: Docker@2
            displayName: "Build Docker Image"
            inputs:
              command: "build"
              Dockerfile: "Dockerfile"
              tags: "latest"
              arguments: "--cache-from type=local,src=/tmp/.buildx-cache --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max"
