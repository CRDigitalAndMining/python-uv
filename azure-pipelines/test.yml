# Test Pipeline with Coverage
# Equivalent to .github/workflows/test.yml

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - "**.py"
      - ".coveragerc"
      - ".env**"
      - ".python-version"
      - "tests/**"
      - "pyproject.toml"
      - "pytest.ini"
      - "uv.lock"
      - "azure-pipelines/test.yml"

pr:
  branches:
    include:
      - main
  paths:
    include:
      - "**.py"
      - ".coveragerc"
      - ".env**"
      - ".python-version"
      - "tests/**"
      - "pyproject.toml"
      - "pytest.ini"
      - "uv.lock"
      - "azure-pipelines/test.yml"

pool:
  vmImage: "ubuntu-latest"

jobs:
  - job: Coverage
    displayName: "Run Tests with Coverage"
    steps:
      - checkout: self

      - script: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "##vso[task.prependpath]$HOME/.cargo/bin"
        displayName: "Install uv"

      - script: |
          uv sync --frozen
        displayName: "Install dependencies with uv"

      - script: |
          uv run nox -s test -- --junitxml=test-results.xml
        displayName: "Run pytest with coverage"

      - task: PublishTestResults@2
        displayName: "Publish Test Results"
        condition: always()
        inputs:
          testResultsFormat: "JUnit"
          testResultsFiles: "test-results.xml"
          failTaskOnFailedTests: true

      - task: PublishCodeCoverageResults@2
        displayName: "Publish Code Coverage"
        condition: always()
        inputs:
          summaryFileLocation: "htmlcov/index.html"
          pathToSources: "$(System.DefaultWorkingDirectory)"
